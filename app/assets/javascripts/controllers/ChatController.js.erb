'use strict';

angular.module('chatApp').controller('ChatController', function ($scope, $rootScope, $route, $http, $location, $timeout, $sce, Crypt, timeUpdate) {
  var campaign_data;
  var visitor_data = {};
  $scope.visitor_fb_data = {
    id: '',
    name: '',
    first_name:'',
    last_name: '',
    email: ''
  };
  var chat_data = {
    chat_uid: ''
  };
  var operator_data = {
    uid: $location.search()['o'] || ''
  };
  var video_completed=false;
  var window_focus=false;
  var YTplayer;
  $scope.growthChallengeStep = -1;
  $scope.liveChat=false;
  $scope.mobileMinChat=true;
  if(angular.isDefined($route.current.params.refer)){
    $scope.christianFriendEmail = Crypt.decodeStr($route.current.params.refer);
  }else{
    $scope.christianFriendEmail = '';
  }

  $http({method: 'GET', url: '/api/campaigns/' + $route.current.params.campaignId}).
    success(function (data, status, headers, config) {
      campaign_data = data;
      campaign_data.video_start = 0;
      campaign_data.video_end = 235;

      $scope.campaign_data = campaign_data;
      window.document.title = campaign_data.title;

      if (campaign_data.type === 'youtube') {
        var tag = document.createElement('script');
        var title = document.title;
        tag.src = "//www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        window.onYouTubeIframeAPIReady = function () {
          $('body').addClass('video');
          YTplayer = new YT.Player('player', {
            //videoId: campaign_data.video_id,
            videoId: 'KGlx11BxF24',
            playerVars: {
              autoplay: 0,
              modestbranding: 1,
              rel: 0,
              showinfo: 0,
              iv_load_policy: 3,
              html5: 1,
              start: campaign_data.video_start,
              end: campaign_data.video_end
            },
            events: {
              'onStateChange': onPlayerStateChange
            }
          });
        };
      }

      //create visitor
      $http({method: 'POST', url: '/api/visitors'}).
        success(function (data, status, headers, config) {
          visitor_data = data;
          visitor_data.profile_pic = '<%= asset_path("avatar.png") %>';
          if(campaign_data.preemptive_chat){
            $scope.startChat('');
          }
        }).error(function (data, status, headers, config) {
        });

      $scope.campaign_data.followup_buttons.push({
        id: 1,
        text: 'No thanks',
        action: 'chat',
        value: '',
        message_active_chat: '<p>You said "No" to following Jesus.</p><h1>That\'s honest!</h1><p>We appreciate the time you gave to watch Falling Plates.Thanks for telling us straight up what you think. There is obviously a reason in your mind right now that causes you to say no to following Jesus. We would love to have a chat about it. If you are interested we can chat about your perspective...</p>',
        message_no_chat: '<p>You said "No" to following Jesus.</p><h1>That\'s honest!</h1><p>Thanks for telling us straight up what you think. We really appreciate the time you gave to watch Falling Plates. There is obviously a reason in your mind right now that causes you to say no to following Jesus. The next best step for you is to really talk to a Christian friend that you know and trust. If you are interested, we will help you find one. Check out the "Growth Challenge"</p>',
        message_growth_challenge: 'It\'s simple and it\'s free! Over the next 4 weeks we’ll email you a new thought-provoking video with discussion questions about a relationship with Jesus.',
        message_friend_title: 'Why involve a Christian friend you know and trust?',
        message_friend: 'To get a genuine look at how your friend follows Jesus. Select someone you know and trust, who has mentioned their faith to you, and is able to listen.',
        message_finished: $sce.trustAsHtml('<p>Thanks for taking the time to watch #Fallingplates today. We hope that the film made a real impact in how you understand God’s love for you. Spiritual growth is a key value to us at Cru. We hope that beyond watching - thinking  and chatting that you can actually grow into all that God would have for you. We pray that signing up for the Growth Challenge today and adding a friend will be transformative! We pray you grow! Go check your email to confirm your subscription.</p><p>God bless your growth.<br>Your friends at Cru<br><a href="http://www.cruoncampus.org" target="_blank">www.cruoncampus.org</a></p>')
      });
      $scope.campaign_data.followup_buttons.push({
        id: 2,
        text: 'I follow another faith',
        action: 'chat',
        value: '',
        message_active_chat: '<p>You said "I follow another faith"</p><h1>That\'s appreciated!</h1><p>Thanks for taking time to watch #Fallingplates and considering how Jesus desires to bring life to you today. What is it that you find interesting about Jesus? Lets chat about that if you are interested...</p>',
        message_no_chat: '<p>You said "I follow another faith"</p><h1>That\'s appreciated!</h1><p>Thanks for taking time to watch #Fallingplates and considering how Jesus desires to bring life to you today. We would like to help you understand the uniqueness of Jesus and what we believe he has done for you. If you are interested to look into this with one of your Christian friends that you know and trust, let us help you connect with them...You interested? Check out the "Growth Challenge"</p>',
        message_growth_challenge: 'It\'s simple and it\'s free! Over the next 4 weeks we’ll email you a new thought-provoking video with discussion questions about a relationship with Jesus.',
        message_friend_title: 'Why involve a Christian friend you know and trust?',
        message_friend: 'To get a genuine look at how your friend follows Jesus. Select someone you know and trust, who has mentioned their faith to you, and is able to listen.',
        message_finished: $sce.trustAsHtml('<p>Thanks for taking the time to watch #Fallingplates today. We hope that the film made a real impact in how you understand God’s love for you. Spiritual growth is a key value to us at Cru. We hope that beyond watching - thinking  and chatting that you can actually grow into all that God would have for you. We pray that signing up for the Growth Challenge today and adding a friend will be transformative! We pray you grow! Go check your email to confirm your subscription.</p><p>God bless your growth.<br>Your friends at Cru<br><a href="http://www.cruoncampus.org" target="_blank">www.cruoncampus.org</a></p>')
      });
      $scope.campaign_data.followup_buttons.push({
        id: 3,
        text: 'I am not sure',
        action: 'chat',
        value: '',
        message_active_chat: '<p>You said "I\'m not sure" to following Jesus.<h1>That\'s honest!</h1><p>Thanks for watching #FallingPlates and considering Jesus\'s call to follow Him. We are pumped that you are at least considering following Jesus! What is one thing that is attractive to you in following Jesus? What is one thing that makes you hesitant? We\'d love to chat with you about this stuff in the chat panel...</p>',
        message_no_chat: '<p>You said "I\'m not sure" to following Jesus.<h1>That\'s honest!</h1><p>Thanks for taking time to watch #FallingPlates and for considering Jesus\'s call to follow Him. We are glad that you are at least considering following Jesus. What is one thing that is attractive to you in following Jesus? What is one thing that makes you hesitant? We have a growth challenge that can help you find significance in following Jesus. Check out the "Growth Challenge"</p>',
        message_growth_challenge: 'It\'s simple and it\'s free! Over the next 4 weeks we’ll email you a new thought-provoking video with discussion questions about a relationship with Jesus.',
        message_friend_title: 'Why involve a Christian friend you know and trust?',
        message_friend: 'So you can get some insight from your friend on what it looks like to follow Jesus.',
        message_finished: $sce.trustAsHtml('<p>Thanks for taking the time to watch #Fallingplates today. We hope that the film made a real impact in how you understand God’s love for you. Spiritual growth is a key value to us at Cru. We hope that beyond watching - thinking  and chatting that you can actually grow into all that God would have for you. We pray that signing up for the Growth Challenge today and adding a friend will be transformative! We pray you grow! Go check your email to confirm your subscription.</p><p>God bless your growth.<br>Your friends at Cru<br><a href="http://www.cruoncampus.org" target="_blank">www.cruoncampus.org</a></p>')
      });
      $scope.campaign_data.followup_buttons.push({
        id: 4,
        text: 'I want to start',
        action: 'chat',
        value: '',
        message_active_chat: '<p>You said "I want to start" following Jesus!</p><h1>That\'s Awesome!</h1><p>Thanks for taking time to watch #FallingPlates and for considering Jesus\'s call to follow Him. To desire to start following Jesus is a significant step! It\'s awesome to see you have that desire! Tell us a bit about what\'s up, what made you want to start? We\'d love to chat with you about this stuff in the chat panel...</p>',
        message_no_chat: '<p>You said "I want to start" following Jesus!</p><h1>That\'s Awesome!</h1><p>Thanks for taking time to watch #FallingPlates and for considering Jesus\'s call to follow Him. To want to start following Jesus is a significant step. It\'s awesome to see you have that desire! We have a growth challenge that can help you grow if you want to start following Christ. Here\'s the best place for you to get connected with a friend to grow... Checkout the "Growth Challenge"</p>',
        message_growth_challenge: 'It\'s simple and it\'s free! Over the next 4 weeks we’ll email you a new thought-provoking video with discussion questions about your relationship with Jesus.',
        message_friend_title: 'Why involve a Christian friend you know and trust?',
        message_friend: 'Following Jesus is meant to happen with others [in community]. Who better to start this with, than a friend you know and trust?',
        message_finished: $sce.trustAsHtml('<p>Thanks for taking the time to watch #Fallingplates today. We hope that the film made a real impact in how you understand God’s love for you. Spiritual growth is a key value to us at Cru. We hope that beyond watching - thinking  and chatting that you can actually grow into all that God would have for you. We pray that signing up for the Growth Challenge today and adding a friend will be transformative! We pray you grow! Go check your email to confirm your subscription.</p><p>God bless your growth.<br>Your friends at Cru<br><a href="http://www.cruoncampus.org" target="_blank">www.cruoncampus.org</a></p>')
      });
      $scope.campaign_data.followup_buttons.push({
        id: 5,
        text: 'I\'m trying',
        action: 'chat',
        value: '',
        message_active_chat: '<p>You said "I\'m trying" to following Jesus!</p><h1>That\'s honest!</h1><p>Thanks for watching #FallingPlates and taking time to express how you feel about following Jesus. Sometimes we feel like we will never get there, be good enough or be the person God wants us to be...which can leave us feeling disappointed or disillusioned. We\'d love to chat with you about this stuff in the chat panel...</p>',
        message_no_chat: '<p>You said "I\'m trying" to following Jesus!</p><h1>That\'s honest!</h1><p>Thanks for watching #FallingPlates and taking time to express how you feel about following Jesus. Sometimes we feel like we will never get there, be good enough or be the person God wants us to be...which can leave us feeling disappointed or disillusioned. We have a Growth Challenge that can help you find real satisfaction and confidence in following Jesus. It will help you understand that the relationship is based on his efforts which are sufficient  Checkout the "Growth Challenge"</p>',
        message_growth_challenge: 'It\'s simple and it\'s free! Over the next 4 weeks we’ll email you a new thought-provoking video with discussion questions about your relationship with Jesus.',
        message_friend_title: 'Why involve a Christian friend you know and trust?',
        message_friend: 'Following Jesus is meant to happen with others [in community]. Who better to start this with, than a friend you know and trust?',
        message_finished: $sce.trustAsHtml('<p>Thanks for taking the time to watch #Fallingplates today. We hope that the film made a real impact in how you understand God’s love for you. Spiritual growth is a key value to us at Cru. We hope that beyond watching - thinking  and chatting that you can actually grow into all that God would have for you. We pray that signing up for the Growth Challenge today and adding a friend will be transformative! We pray you grow! Go check your email to confirm your subscription.</p><p>God bless your growth.<br>Your friends at Cru<br><a href="http://www.cruoncampus.org" target="_blank">www.cruoncampus.org</a></p>')
      });
      $scope.campaign_data.followup_buttons.push({
        id: 6,
        text: 'I\'m following Jesus',
        action: 'chat',
        value: '',
        message_active_chat: '<p>You said "I am following Jesus"</p><h1>That\'s Awesome!</h1><p>We are pumped that you are following Jesus! We would love to connect with you and discover how your journey is going and what you think the next steps are to be who He wants you to be? Let\'s chat...</p>',
        message_no_chat: '<p>You said "I am following Jesus"</p><h1>That\'s Awesome!</h1><p>We are pumped that you are following Jesus! We know that its not always an easy path, but it\'s definitely worth it :)  We don\'t know all that\'s going on in your life today, but we are glad He led you here! It\'s our goal to help you grow and to help you have influence. We would love to connect you with someone in the adventure of knowing Jesus. Checkout the "Growth Challenge"</p>',
        message_growth_challenge: 'The best Growth Challenge you can take is impacting one of your friends! Enter your info and over the next four weeks we will email you a new thought-provoking video about how a person can begin following Jesus.',
        message_friend_title: 'What type of friend do I invite?',
        message_friend: 'Then invite one person you want to know Jesus to take this Growth Challenge with you. They\'ll get a link, watch #FallingPlates, and have the chance to accept your invitation.',
        message_finished: $sce.trustAsHtml('<p>Thanks for taking the time to watch #Fallingplates today. We hope that your experience today has been one of excitement in realising you can impact others with your faith. Thanks also for signing up in the growth challenge as a mentor to the friend you invited. Pray that the friend you invited actually comes and signs up to the growth challenge alongside you! The mentor material you get matches the material your friend will be getting. So go check your email to confirm your 4 week subscription and get on with the Growth Challenge with your friend. We pray you grow! </p><p>God bless your growth.<br>Your friends at Cru<br><a href="http://www.cruoncampus.org" target="_blank">www.cruoncampus.org</a></p>')
      });
    }).error(function (data, status, headers, config) {
      document.write('Error: invalid campaign id.');
    });

  $scope.postMessage = function () {
    if($scope.chatMessage==''){
      return;
    }
    var post_data = {
      user_uid: visitor_data.uid,
      message_type: 'user',
      message: $scope.chatMessage
    };
    $scope.chatMessage = '';
    //$('.chat-input').attr('placeholder','Sending...');
    $http({method: 'POST', url: '/api/chats/'+chat_data.chat_uid+'/messages', data: post_data}).
      success(function (data, status, headers, config) {
        //$('.chat-input').attr('placeholder','Message...');
        $('.body').append('<div class="content"><img class="avatar" src="' + visitor_data.profile_pic + '"><div class="message">' + post_data.message + '</div>' +
                '<div class="name muted"><div class="date timestamp-refresh" timestamp="' + Math.round(+new Date()).toString() + '">Just Now</div>You</div>' +
                '</div>');
        $('.body').scrollTop($('.body')[0].scrollHeight);
      }).error(function (data, status, headers, config) {
        //$('.chat-input').attr('placeholder','Message...');
      });
  };

  $scope.startChat = function(initialMsg){
    if(!video_completed && !campaign_data.preemptive_chat){
      $('#finishVideo').fadeIn(1).delay(3000).fadeOut(1);
      $('#start-chat-panel').fadeOut(1).delay(3000).fadeIn(1);
      return;
    }
    if(chat_data.chat_uid){ //chat already started
      return;
    }

    var data = {
      campaign_uid: campaign_data.uid,
      visitor_uid: visitor_data.uid,
      operator_uid: operator_data.uid
    };
    $http({method: 'POST', url: '/api/chats', data: data}).
      success(function (data, status, headers, config) {
        chat_data = data;
        operator_data = data.operator;
        if(angular.isDefined($scope.button_clicked)){
          $scope.button_clicked.message_visible = $sce.trustAsHtml($scope.button_clicked.message_active_chat);
        }

        $scope.liveChat=true;
        $scope.growthChallengeStep = 1;

        $('.operator').html('<img class="avatar" src="' + operator_data.profile_pic + '">' +
          '<div class="message">You are chatting with<br>' + operator_data.name + '</div>');
        var pusher = new Pusher('249ce47158b276f4d32b');
        pusher.subscribe('visitor_' + visitor_data.uid);
        var channel_chat = pusher.subscribe('chat_'+chat_data.chat_uid);
        channel_chat.bind('event', function (data) {
          if (data.user_uid != visitor_data.uid) {
            if (data.message_type == 'activity') {
              if(data.message == 'challenge'){
                $('.after-chat-challenge').fadeIn();
                $scope.postActivityMessage('Growth Challenge visible');
                $('body').scrollTop($('body')[0].scrollHeight);
                $('.body').append('<div class="system"><div class="date timestamp-refresh" timestamp="' + Math.round(+new Date()).toString() + '">Just Now</div>' +
                        '<div class="message">Growth Challenge visible</div>' +
                        '</div>');
                $('.body').scrollTop($('.body')[0].scrollHeight);
                clicky.goal(campaign_data.permalink + ': Growth Challenge visible');
              }
            } else {
              $('.body').append('<div class="content odd"><img class="avatar" src="' + operator_data.profile_pic + '"><div class="message">' + data.message + '</div>' +
                      '<div class="name muted"><div class="date timestamp-refresh" timestamp="' + Math.round(+new Date()).toString() + '">Just Now</div>' + operator_data.name + '</div>' +
                      '</div>');
              $('.body').scrollTop($('.body')[0].scrollHeight);
              $scope.$apply(function(){
                $scope.mobileMinChat=false;
              });
              if (!window_focus) {
                $('#newMsgAlert')[0].play();
              }
            }
          }
        });

        channel_chat.bind('end', function (data) {
          pusher.unsubscribe('chat_'+chat_data.chat_uid);
          $('#chatEnd').show();
          $('.body').empty();
          chat_data.chat_uid = '';
          $scope.$apply(function(){
            $scope.liveChat=false;
          });
        });

        if(initialMsg){
          $timeout(function(){ $scope.postActivityMessage(initialMsg, 'activity-button'); }, 2500);
        }
        $timeout(function(){ $scope.postActivityMessage(clientIP, 'ip'); }, 2600);
        $timeout(function(){ $scope.postActivityMessage(getBrowser(), 'browser'); }, 2800);
        $timeout(function(){ $scope.postActivityMessage(getOS(), 'os'); }, 3000);
      }).error(function (data, status, headers, config) {
        if(data.error === 'no_operators_available'){
          try{
            $scope.button_clicked.message_visible = $sce.trustAsHtml($scope.button_clicked.message_no_chat) || $sce.trustAsHtml('');
            chat_data.chat_uid = 'offline';
            $('.after-chat-challenge').fadeIn();
            $scope.growthChallengeStep=1;
          }catch(e){}
          //Get Operator Info
          if(operator_data.uid){
            $http({method: 'GET', url: '/api/operators/' + operator_data.uid}).
              success(function (data, status, headers) {
                operator_data = data;
                $scope.operator_data = data;
                $('#noOperators').show();
              }).error(function() {
                $('#noOperators').show();
              });
          }else{
            $('#noOperators').show();
          }
        }else{
          alert('Error: ' + (data.message || 'Cannot create new chat.'));
        }
      });
  };

  $scope.buttonClick = function(button){
    $scope.button_clicked = button;

    if(!chat_data.chat_uid){
      $scope.startChat(button.text);
    }else{
      $scope.postActivityMessage(button.text, 'activity-button');
      $scope.button_clicked.message_visible = $sce.trustAsHtml($scope.button_clicked.message_active_chat);
      $scope.growthChallengeStep = 1;
      $('.after-chat-challenge').show();
    }
    clicky.goal(campaign_data.permalink + ': Button Click: ' + button.id + ' (' + button.text + ')');
  };

  $scope.postActivityMessage = function(message, message_type){
    if(chat_data.chat_uid==='offline'){
      return;
    }
    if(message_type){
      //var message_type=message_type;
    }else{
      var message_type='activity';
    }
    var post_data = {
      user_uid: visitor_data.uid,
      message_type: message_type,
      message: message
    };
    $http({method: 'POST', url: '/api/chats/'+chat_data.chat_uid+'/messages', data: post_data}).
      success(function (data, status, headers, config) {
      }).error(function (data, status, headers, config) {
      });
  };

  $scope.facebookLogin = function(){
    FB.login(function(response) {
      if (response.authResponse) {
        FB.api('/me', function(response) {
          //console.log(response);
          $scope.$apply(function(){
            visitor_data.profile_pic = 'http://graph.facebook.com/'+response.id+'/picture?width=45&height=45';
            $scope.visitor_email = response.email;
            $scope.visitor_fb_data = response;
          });
          postVisitorInfo(response);
          $('.body').append('<div class="system"><div class="date timestamp-refresh" timestamp="' + Math.round(+new Date()).toString() + '">Just Now</div>' +
                  '<div class="message">Logged in with Facebook</div>' +
                  '</div>');
          $('.body').scrollTop($('.body')[0].scrollHeight);
        });
        clicky.goal(campaign_data.permalink + ': Logged in with Facebook');
      }
    });
  }

  $scope.growthChallengeNextStep = function(step){
    if(step==2){
      $('.after-chat-challenge').hide();
      $scope.growthChallengeStep=2;
    }else if(step==3){
      var button_id = $scope.button_clicked.id;
      if($scope.button_clicked.id===6){
        $scope.friend_url = 'http://www.watchthinkchat.com/c/' + campaign_data.uid + '?o=' + $scope.visitor_fb_data.id + '&refer=' + encodeURIComponent(Crypt.encodeStr($scope.visitor_email));
      }else{
        $scope.friend_url = 'http://www.watchthinkchat.com/challenge/friend?v=' + visitor_data.uid +
                '&button_id='+button_id +
                '&refer=' + encodeURIComponent(Crypt.encodeStr($scope.visitor_email)) +
                '&n=' + encodeURIComponent(Crypt.encodeStr($scope.visitor_fb_data.first_name));
      }
      $http({method: 'JSONP',
        url: 'https://gcx.us6.list-manage.com/subscribe/post-json?u=1b47a61580fbf999b866d249a&id=c3b97c030f' +
                '&EMAIL=' + encodeURIComponent($scope.visitor_email) +
                '&FNAME=' + encodeURIComponent($scope.visitor_fb_data.first_name) +
                '&LNAME=' + encodeURIComponent($scope.visitor_fb_data.last_name) +
                '&RESPCODE=' + encodeURIComponent(button_id) +
                '&c=JSON_CALLBACK'
      }).success(function (data, status, headers, config) {
        if (data.result === 'success') {
          $scope.growthChallengeStep=3;

          //notify mission hub
          var post_data = {
            fb_uid: $scope.visitor_fb_data.id,
            visitor_email: $scope.visitor_email,
            challenge_subscribe_self: true
          };
          $http({method: 'PUT', url: '/api/visitors/'+visitor_data.uid, data: post_data}).
                  success(function (data, status, headers, config) {
                  }).error(function (data, status, headers, config) {
                  });
        } else {
          alert('Error: ' + data.msg);
        }
      }).error(function (data, status, headers, config) {
        alert('Error: Could not connect to mail service.');
      });
    }
  }

  $scope.growthChallengeInviteFriend = function(how){
    if(how=='fb'){
      FB.ui({
        method: 'send',
        link: $scope.friend_url
      });
      $scope.growthChallengeStep=10;
    }else if(how=='email'){
      $scope.email_message='I just watched a Christian film called #FallingPlates and decided to accept the "Growth Challenge" that was offered. I got to pick one friend to help me grow spiritually and I chose you!\n\n' +
              'Would you be willing to help by looking at the email content we would get, and then discussing it with me? This means 4 emails, 4 conversations over 4 weeks. That\'s it.\n\n' +
              'Lets take the challenge together!\n\n' +
              'You can click here to find out more information:\n' +
              $scope.friend_url;
      $('#growth-challenge-invite-friend').modal({backdrop: true, show: true});
    }else if(how=='sendemail'){
      if(!$scope.visitor_name){
        alert('Please enter Your Name.');
        return;
      }
      if(!validateEmail($scope.visitor_email)){
        alert('Your Email must be a valid email address.');
        return;
      }
      if(!validateEmail($scope.friend_email)){
        alert('Your Friend\'s Email must be a valid email address.');
        return;
      }

      //Send email
      $('#growth-challenge-invite-friend .modal-footer button').hide();
      $('#growth-challenge-invite-friend .modal-footer p').show();
      var post_data = {
        to: $scope.friend_email,
        from: $scope.visitor_email,
        from_name: $scope.visitor_name,
        subject: 'Take the "Growth Challenge" with me',
        message: $scope.email_message
      };
      $http({method: 'POST', url: '/api/emails', data: post_data}).
        success(function (data, status, headers, config) {
          $('#growth-challenge-invite-friend').modal('hide');
          $scope.growthChallengeStep=10;
        }).error(function (data, status, headers, config) {
          $('#growth-challenge-invite-friend .modal-footer button').show();
          $('#growth-challenge-invite-friend .modal-footer p').hide();
          alert('Error: '+data);
        });
    }else if(how=='accept'){
      //Send email
      $scope.growthChallengeStep=10;
      var post_data = {
        to: $scope.christianFriendEmail,
        from: $scope.visitor_email,
        from_name: $scope.visitor_name,
        subject: 'Your friend has accepted your "Growth Challenge"!',
        message: $scope.visitor_fb_data.name + ' has accepted to take the Growth Challenge with you!'
      };
      $http({method: 'POST', url: '/api/emails', data: post_data}).
        success(function (data, status, headers, config) {
        }).error(function (data, status, headers, config) {
        });
    }
  };

  $scope.sendFbMsgToOperator = function(){
    FB.ui({
      method: 'send',
      link: document.URL,
      to: operator_data.uid
    });
  };

  var postVisitorInfo = function(data){
    var chat_uid = chat_data.chat_uid;
    if(chat_uid=='offline'){
    }else{
      $scope.postActivityMessage('Visitor has logged in with Facebook.');
      var post_data = {
        user_uid: visitor_data.uid,
        message_type: 'fbName',
        message: data.name
      };
      $http({method: 'POST', url: '/api/chats/'+chat_uid+'/messages', data: post_data}).
              success(function (data, status, headers, config) {
              }).error(function (data, status, headers, config) {
              });
      var post_data = {
        user_uid: visitor_data.uid,
        message_type: 'fbEmail',
        message: data.email
      };
      $http({method: 'POST', url: '/api/chats/'+chat_uid+'/messages', data: post_data}).
              success(function (data, status, headers, config) {
              }).error(function (data, status, headers, config) {
              });
      var post_data = {
        user_uid: visitor_data.uid,
        message_type: 'fbId',
        message: data.id
      };
      $http({method: 'POST', url: '/api/chats/'+chat_uid+'/messages', data: post_data}).
              success(function (data, status, headers, config) {
              }).error(function (data, status, headers, config) {
              });
    }
  };

  $scope.updateVisitorName = function(){
    if(visitor_data.name===$scope.visitor_fb_data.name){
      return;
    }
    var post_data = {
      user_uid: visitor_data.uid,
      message_type: 'fbName',
      message: $scope.visitor_fb_data.name
    };
    $http({method: 'POST', url: '/api/chats/'+chat_data.chat_uid+'/messages', data: post_data}).
      success(function (data, status, headers, config) {
        visitor_data.name=$scope.visitor_fb_data.name;
        $('.body').append('<div class="system"><div class="date timestamp-refresh" timestamp="' + Math.round(+new Date()).toString() + '">Just Now</div>' +
                '<div class="message">Name set to: ' + $scope.visitor_fb_data.name + '</div>' +
                '</div>');
        $('.body').scrollTop($('.body')[0].scrollHeight);
        $scope.visitor_fb_data.id='0';
      }).error(function (data, status, headers, config) {
      });
  }

  $scope.growthChallengePrevStep = function(){
    switch($scope.growthChallengeStep){
      case 1:
        $scope.growthChallengeStep=0;
        $('.after-chat-challenge').hide();
        break;
      case 2:
        $scope.growthChallengeStep=1;
        $('.after-chat-challenge').show();
        break;
      case 3:
        $scope.growthChallengeStep=2;
        break;
      case 9:
        $scope.growthChallengeStep=3;
        break;
    }
  }

  $scope.$watch('growthChallengeStep', function(newValue, oldValue) {
    switch(newValue){
      case 2:
        clicky.goal(campaign_data.permalink + ': Started Growth Challenge');
      case 3:
        $scope.postActivityMessage('Visitor has signed up for the Growth Challenge.');
        clicky.goal(campaign_data.permalink + ': Signed Up for Growth Challenge');
        var post_data = {
          user_uid: visitor_data.uid,
          message_type: 'fbEmail',
          message: $scope.visitor_email
        };
        $http({method: 'POST', url: '/api/chats/'+chat_data.chat_uid+'/messages', data: post_data}).
          success(function (data, status, headers, config) {
          }).error(function (data, status, headers, config) {
          });
        break;
      case 9:
        $scope.postActivityMessage('Visitor has chose to "Go it Along".');
        break;
      case 10:
        $scope.postActivityMessage('Visitor has invited a friend and completed the Growth Challenge.');
        clicky.goal(campaign_data.permalink + ': Invited friend and completed Growth Challenge');
        break;
      case 99:
        $scope.postActivityMessage('Visitor has closed the Growth Challenge".');
        break;
      default:
    }
  });

  var onPlayerStateChange = function (evt) {
    switch (evt.data) {
      case YT.PlayerState.PLAYING:
        clicky.goal(campaign_data.permalink + ': Video Started');
        break;
      case YT.PlayerState.ENDED:
        if(!video_completed){
          $scope.$apply(function(){
            $scope.growthChallengeStep = 0;
          });
          YTplayer.stopVideo();
          $("#player").attr('src', '');
          $('body').removeClass('video');
          clicky.goal(campaign_data.permalink + ': Video Completed');
        }
        video_completed=true;
        break;
      case YT.PlayerState.PAUSED:
        break;
    }
  };

  var getBrowser = function(){
    var ua= navigator.userAgent, tem,
      M= ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*([\d\.]+)/i) || [];
    if(/trident/i.test(M[1])){
      tem=  /\brv[ :]+(\d+(\.\d+)?)/g.exec(ua) || [];
      return 'IE '+(tem[1] || '');
    }
    M= M[2]? [M[1], M[2]]:[navigator.appName, navigator.appVersion, '-?'];
    if((tem= ua.match(/version\/([\.\d]+)/i))!= null) M[2]= tem[1];
    return M.join(' ');
  }

  var getOS = function(){
    var OSName="Unknown OS";
    if (navigator.appVersion.indexOf("Win")!=-1) OSName="Windows";
    if (navigator.appVersion.indexOf("Mac")!=-1) OSName="MacOS";
    if (navigator.appVersion.indexOf("X11")!=-1) OSName="UNIX";
    if (navigator.appVersion.indexOf("Linux")!=-1) OSName="Linux";
    return OSName;
  }
  var validateEmail = function(email) {
    var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(email);
  }


  $(window).focus(function() {
    window_focus=true;
  }).blur(function() {
    window_focus=false;
  });
});